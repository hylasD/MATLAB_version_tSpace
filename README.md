# tSpace algorithm for unsupervised deteremination of multiple developmental branches in single cell data
By Denis Dermadi
Trajectory algorithm MATLAB code

## Formal description of the tSpace algorithm

Every analyzed cell c<sub>_i_</sub> is defined by a vector of expression values (v) for each measured marker (m), c<sub>_i_</sub> = (v<sub>1</sub>, v<sub>2</sub>, v<sub>3</sub>, …, v<sub>_j_</sub>), where _i_ is between 1 and the total number of cells (n) and _j_ is the number of measured markers (m). Profiles of all cells within a sample form an input matrix M (v<sub>_ij_</sub>), _i_ ∈ \[1, n\] and _j_ ∈ \[1, m\]. Prior to application of tSpace, the input matrix has to be cleaned for outliers and artifacts and adequately transformed, e.g. logicle for FACS data, the inverse hyperbolic sine function for CyTOF and logarithmic for _sc_\RNAseq. 

The concept of _trajectory space_ is a space in which each cell is represented as a vector of trajectory distances to every other cell in the data set. Implementation of the concept through the tSpace algorithm involves three steps. 

In the first step tSpace calculates a k nearest neighbor (kNN) graph, in which the k nearest neighbors of each cell are defined. The user-defined neighborhood size (k), preferably small, is selected to allow inclusion of every cell in the graph. As implemented, the nearest neighbors are determined using either cosine or Euclidean metrics. 

The second step of tSpace is computation of a _trajectory space_ matrix. This step utilizes parallelization for performance improvement. tSpace computes distances from each cell to every other cell within the kNN graph using modified Dijkstra algorithm, originally published under name Wanderlust[1](https://www.ncbi.nlm.nih.gov/pubmed/24766814). Briefly, for each cell c<sub>_i_</sub>, Wanderlust initially calculates several trajectories, user-defined by the number g of sub-graphs selected, that are averaged to generate a consensus distance to every other cell. Each of the sub-graphs (g) is created by randomly selecting l out of the k neighbors (l < k) from every cell. Cell distances in the trajectory within each graph are calculated in relationship to both the start cell and to “waypoint cells” that are randomly picked following uniform distribution. The number of waypoints (wp) is user defined. Distances from the start cell to every other cell are iteratively refined until convergence using the waypoints and exponential weighing scheme. Essentially, waypoints closer to the start cell contribute more in distance calculation than further ones. The final trajectory space matrix is a matrix of Wanderlust refined distances (d) from each cell to every cell in the dataset, T = (d<sub>_ij_</sub>), _i_ & _j_ ∈ \[1, n\], with n being total number of measured cells, and each cell is described by a vector of Wanderlust distances c<sub>_i_</sub> = (d<sub>1</sub>, d<sub>2</sub>, d<sub>3</sub>, …, d<sub>_j_</sub>), _i_ & _j_ ∈ \[1, n\].

Lastly, dimensionality reduction with PCA is used to visualize cells and their relationships in _trajectory space_. 

In the ideal situation, the number of trajectories t is equal to the number of analyzed cells (n), however when datasets are large (n > 10000), we determined empirically that 100 – 1000 trajectories are usually sufficient for correct determination of branching points and trajectories, and trajectory space matrix can be defined as T = (d<sub>_ij_</sub>), _i_ ∈ \[1, n\], _j_ ∈ \[1, t\], and each cell is described by a vector of Wanderlust distances c<sub>_i_</sub> = (d<sub>1</sub>, d2<sub>2</sub> d<sub>3</sub>, …, d<sub>_j_</sub>), _j_ ∈ \[1, t\]. Kmeans and self-organizing map (SOM) clustering methods are implemented in tSPACE algorithm to reassure that each of the calculated trajectories starts from different cellular populations from the whole sample. Kmeans and SOM are calculated using phenotypical markers. MATLAB implementation of tSpace and accompanying documentation are available [here](https://github.com/hylasD/tSpace/blob/master/tspace.m).

